---
title: "Desafio07"
author: "Lucas Dos Santos Almeida"
format: html
editor: visual
---

```{r}
library(RSQLite)
library(tidyverse)
if(!"discoCopy.db" %in% list.files()){
  file.copy("disco.db", "discoCopy.db")
}

db <- dbConnect(SQLite(), "discoCopy.db")

dbExecute(db, "DROP TABLE IF EXISTS instruments")
dbExecute(db, "CREATE TABLE instruments (AlbumId INTEGER, TrackId INTEGER, ElectricGuitar INTEGER, Singer INTEGER, Trumpet INTEGER)")

dbExecute(db, "DROP TABLE instruments")

sql <- paste("SELECT ArtistId FROM artists WHERE Name = ?")
query <- dbSendQuery(db, sql)
dbBind(query, list("Gilberto Gil"))
aId <- dbFetch(query)
dbClearResult(query)
sql <- paste('SELECT Title FROM albums WHERE ArtistId =', aId$ArtistId)
dbGetQuery(db, sql)

dbExecute(db, "DROP TABLE IF EXISTS instruments")
dbExecute(db, "CREATE TABLE instruments (AlbumId INTEGER, TrackId INTEGER, ElectricGuitar INTEGER, Singer INTEGER, Trumpet INTEGER)")

sql <- paste('SELECT TrackId, Name FROM tracks WHERE AlbumId = 85')
dbGetQuery(db, sql) %>% head()

dbExecute(db, "INSERT INTO instruments VALUES ('85','1075', 0, 1, 0),('85','1078', 0, 1, 0)")

dbWriteTable(db, "mtcars", mtcars, overwrite = TRUE)

theAvgCar <- mtcars %>% summarise_all(function(x) round(mean(x), 2))
dbWriteTable(db, "mtcars", theAvgCar, append = TRUE)

dbWriteTable(db, "mtcars", mtcars, overwrite = TRUE)

res <- dbSendQuery(db, "SELECT * FROM mtcars WHERE cyl = 4")
while(!dbHasCompleted(res)){
  chunk <- dbFetch(res, n = 5)
  print(nrow(chunk))
}
dbClearResult(res)

dbDisconnect(db)
if("discoCopy.db" %in% list.files()){
  file.remove("discoCopy.db")
}

airports <- read_csv("airports.csv", col_types = "cccccdd")
airlines <- read_csv("airlines.csv", col_types = "cc")
air <- dbConnect(SQLite(), dbname = "air.db")
dbWriteTable(air, name = "airports", airports)
dbWriteTable(air, name = "airlines", airlines)

dbDisconnect(air)
if("air.db" %in% list.files()){
  file.remove("air.db")
}

library(dbplyr)
db <- dbConnect(SQLite(), "disco.db")
tracks <- tbl(db, "tracks")
tracks %>% head(3)

meanTracks <- tracks %>% group_by(AlbumId) %>% summarise(AvLen = mean(Milliseconds, na.rm = TRUE), AvCost = mean(UnitPrice, na.rm = TRUE))
meanTracks

mT <- meanTracks %>% collect()
mT

dbDisconnect(db)
```
