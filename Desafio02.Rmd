---
title: "Lab02ME315"
author: "Lucas dos Santos"
date: "2025-08-14"
output: html_document
---
```{r}
library(readr)
library(tidyverse)

#Selecionando as companhias 
companhias = c("AA", "DL", "UA","US")
funcao_chuncked = function(x, pos){
  
  #filtrando os dados
  dados_filtrados = x %>% filter(AIRLINE %in% companhias & YEAR == "2015", !is.na(DAY), !is.na(MONTH), !is.na(ARRIVAL_DELAY)) %>% group_by(MONTH, DAY, YEAR, AIRLINE) %>% summarise(numero_voos = n(), numero_atrasados = sum(ARRIVAL_DELAY > 10), .groups = 'drop')

  return(dados_filtrados)
  
}
library(tictoc)

#carregando os dados e verificando o tempo que demora
tic("Importando 1 milhao por vez")
  dados = read_csv_chunked("flights.csv", chunk_size = 1000000, callback = DataFrameCallback$new(funcao_chuncked))
toc()


```

```{r}
library(lubridate)
library(ggplot2)
#Criando a tabela de percentual
tabela_percentual <- dados %>%
  group_by(MONTH, DAY, AIRLINE) %>%
  summarise(
    total_voos = sum(numero_voos, na.rm = TRUE),
    total_atrasados = sum(numero_atrasados, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    percentual_atrasos = (total_atrasados / total_voos) * 100
  )


tabela_percentual <- dados %>%

  group_by(MONTH, DAY, AIRLINE, YEAR) %>%
  summarise(
    total_voos = sum(numero_voos, na.rm = TRUE),
    total_atrasados = sum(numero_atrasados, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Adiciona a coluna com o percentual de atrasos
  mutate(
    percentual_atrasos = (total_atrasados / total_voos) * 100,  data = as.Date(paste(YEAR, MONTH, DAY, sep = "-"))
  )

#Seelecionando os dias, meses e anos e os transformando na classe data
df <- tabela_percentual %>%
  mutate(
    ano = year(data),
    mes = month(data),
    dia_do_mes = day(data),
    dia_da_semana = wday(data, label = TRUE, abbr = TRUE), 
    semana_do_ano = isoweek(data) 
  ) %>% select(-MONTH, -YEAR, -DAY)


#separando por companhia AA
df <- df %>%
  mutate(mes_nome = month(data, label = TRUE))
AA = df %>% filter(AIRLINE == "AA")


# Código para gerar o calendário heatmap

CalendarioAA = ggplot(AA, aes(x = dia_da_semana, y = as.numeric(semana_do_ano), fill = percentual_atrasos)) +
  # Adiciona os quadrados coloridos para cada dia
  geom_tile(color = "white", linewidth = 1.5) +
  
  # Cria um painel para cada mês
  facet_wrap(~ mes_nome, ncol = 3, scales = "free_y") +
  
  # Define a escala de cores, você pode escolher as cores que quiser
  scale_fill_gradient(
    low = "lightblue",
    high = "darkblue",
    name = "Proporção de Atrasos"
  ) +
  
  # Remove os rótulos e títulos dos eixos
  labs(title = "Calendário de Proporção de Atrasos de Voo Companhia AA", x = "", y = "") +
  
  # Ajustes de tema para uma aparência mais limpa
  theme_minimal() +
  theme(
    # Remove os rótulos do eixo Y (números de semana)
    axis.text.y = element_blank(),
    # Remove as marcações do eixo Y
    axis.ticks.y = element_blank(),
    # Ajusta o texto do título de cada mês
    strip.text = element_text(size = 12, face = "bold"),
    # Ajusta a orientação dos dias da semana no eixo X
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

#Separando por companhia DL
DL = df %>% filter(AIRLINE == "DL")

CalendarioDL = ggplot(DL, aes(x = dia_da_semana, y = as.numeric(semana_do_ano), fill = percentual_atrasos)) +
  # Adiciona os quadrados coloridos para cada dia
  geom_tile(color = "white", linewidth = 1.5) +
  
  # Cria um painel para cada mês
  facet_wrap(~ mes_nome, ncol = 3, scales = "free_y") +
  
  # Define a escala de cores, você pode escolher as cores que quiser
  scale_fill_gradient(
    low = "grey90", high = "red",
    name = "Proporção de Atrasos"
  ) +
  
  # Remove os rótulos e títulos dos eixos
  labs(title = "Calendário de Proporção de Atrasos de Voo companhia DL", x = "", y = "") +
  
  # Ajustes de tema para uma aparência mais limpa
  theme_minimal() +
  theme(
    # Remove os rótulos do eixo Y (números de semana)
    axis.text.y = element_blank(),
    # Remove as marcações do eixo Y
    axis.ticks.y = element_blank(),
    # Ajusta o texto do título de cada mês
    strip.text = element_text(size = 12, face = "bold"),
    # Ajusta a orientação dos dias da semana no eixo X
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

#Separando por companhia UA
UA = df %>% filter(AIRLINE == "UA")

CalendarioUA = ggplot(UA, aes(x = dia_da_semana, y = as.numeric(semana_do_ano), fill = percentual_atrasos)) +
  # Adiciona os quadrados coloridos para cada dia
  geom_tile(color = "white", linewidth = 1.5) +
  
  # Cria um painel para cada mês
  facet_wrap(~ mes_nome, ncol = 3, scales = "free_y") +
  
  # Define a escala de cores, você pode escolher as cores que quiser
  scale_fill_gradient(
   low = "lightyellow", high = "orange",
   name = "Proporção de Atrasos"
  ) +
  
  # Remove os rótulos e títulos dos eixos
  labs(title = "Calendário de Proporção de Atrasos de Voo Companhia UA", x = "", y = "") +
  
  # Ajustes de tema para uma aparência mais limpa
  theme_minimal() +
  theme(
    # Remove os rótulos do eixo Y (números de semana)
    axis.text.y = element_blank(),
    # Remove as marcações do eixo Y
    axis.ticks.y = element_blank(),
    # Ajusta o texto do título de cada mês
    strip.text = element_text(size = 12, face = "bold"),
    # Ajusta a orientação dos dias da semana no eixo X
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

#Separando por companhia US
US = df %>% filter(AIRLINE == "US")

CalendarioUS = ggplot(US, aes(x = dia_da_semana, y = as.numeric(semana_do_ano), fill = percentual_atrasos)) +
  # Adiciona os quadrados coloridos para cada dia
  geom_tile(color = "white", linewidth = 1.5) +
  
  # Cria um painel para cada mês
  facet_wrap(~ mes_nome, ncol = 3, scales = "free_y") +
  
  # Define a escala de cores, você pode escolher as cores que quiser
  scale_fill_gradient(
    low = "lightgreen", high = "darkgreen",
    name = "Proporção de Atrasos"
  ) +
  
  # Remove os rótulos e títulos dos eixos
  labs(title = "Calendário de Proporção de Atrasos de Voo Companhia US", x = "", y = "") +
  
  # Ajustes de tema para uma aparência mais limpa
  theme_minimal() +
  theme(
    # Remove os rótulos do eixo Y (números de semana)
    axis.text.y = element_blank(),
    # Remove as marcações do eixo Y
    axis.ticks.y = element_blank(),
    # Ajusta o texto do título de cada mês
    strip.text = element_text(size = 12, face = "bold"),
    # Ajusta a orientação dos dias da semana no eixo X
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

```

```{r}
#Exibindo os Calendarios

CalendarioAA
CalendarioDL
CalendarioUA
CalendarioUS
```

```{r}
#Carregando o reticulate

library(reticulate)

```




```{python}
# Importa as bibliotecas necessárias
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from tqdm import tqdm # Usado para criar a barra de progresso (opcional)

# Define as companhias aéreas de interesse
companhias = ["AA", "DL", "UA", "US"]

#Aqui eu tive que importar os dados novamente porque estava dando erro (Não sei porque)
CHUNK_SIZE = 1000000
FILE_PATH = "flights.csv"


# Inicializa uma lista para armazenar os chunks processados
dados_chunks = []

# Obtém o número total de linhas para a barra de progresso (útil para arquivos grandes)
try:
    with open(FILE_PATH, 'r') as f:
        total_lines = sum(1 for _ in f) - 1 # -1 para o cabeçalho
except FileNotFoundError:
    print(f"Erro: O arquivo '{FILE_PATH}' não foi encontrado.")
    total_lines = None

# Itera sobre o arquivo em chunks
with tqdm(total=total_lines, unit=' lines', disable=total_lines is None) as pbar:
    for chunk in pd.read_csv(FILE_PATH, chunksize=CHUNK_SIZE):
        dados_chunks.append(process_chunk(chunk))
        pbar.update(len(chunk))

# Concatena todos os chunks em um único DataFrame
if dados_chunks:
    dados = pd.concat(dados_chunks, ignore_index=True)


if not dados.empty:

#Estou criando a tabela de percentual
    tabela_percentual = dados.groupby(['MONTH', 'DAY', 'AIRLINE', 'YEAR']).agg(
        total_voos=('numero_voos', 'sum'),
        total_atrasados=('numero_atrasados', 'sum')
    ).reset_index()

    tabela_percentual['percentual_atrasos'] = (tabela_percentual['total_atrasados'] / tabela_percentual['total_voos']) * 100
    tabela_percentual['data'] = pd.to_datetime(tabela_percentual[['YEAR', 'MONTH', 'DAY']])
    tabela_percentual['mes_nome'] = tabela_percentual['data'].dt.strftime('%B')
    
    # Mudei a ordem para "Sunday" 
    tabela_percentual['dia_da_semana'] = tabela_percentual['data'].dt.day_name()
    dias_semana_ordem = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
    tabela_percentual['dia_da_semana'] = pd.Categorical(
        tabela_percentual['dia_da_semana'],
        categories=dias_semana_ordem,
        ordered=True
    )
    
    tabela_percentual['semana_do_mes'] = (tabela_percentual['data'].dt.dayofyear - 
                                          tabela_percentual.groupby('mes_nome')['data'].transform(lambda x: x.dt.dayofyear.min())) // 7 + 1
    
    cores = {
        'AA': 'YlGnBu',
        'DL': 'Oranges',
        'UA': 'Reds',
        'US': 'Greens'
    }

    # Gera o calendário heatmap para cada companhia
    for companhia in companhias:
        df_companhia = tabela_percentual[tabela_percentual['AIRLINE'] == companhia].copy()

        # O layout se torna dinâmico aqui
        meses_com_dados = df_companhia['mes_nome'].unique()
        num_meses_com_dados = len(meses_com_dados)
        num_rows = int(np.ceil(num_meses_com_dados / 3))
        
        # Cria a figura e os subplots com base no número de meses com dados
        fig, axes = plt.subplots(num_rows, 3, figsize=(18, 5 * num_rows), gridspec_kw={'hspace': 0.4})
        
        # Adiciona o título do calendário da companhia
        fig.suptitle(f'Calendário {companhia}', fontsize=20, y=1.02)
        
        # Remove os subplots extras antes de plotar
        if num_meses_com_dados < len(axes.flatten()):
            for ax_to_remove in axes.flatten()[num_meses_com_dados:]:
                ax_to_remove.remove()

        for i, mes in enumerate(meses_com_dados):
            ax = axes.flatten()[i]
            
            df_mes = df_companhia[df_companhia['mes_nome'] == mes]
            
            calendario_data = df_mes.pivot_table(
                index='semana_do_mes',
                columns='dia_da_semana',
                values='percentual_atrasos'
            )
            
            calendario_data = calendario_data.reindex(index=calendario_data.index.sort_values(ascending=False))
            
            sns.heatmap(
                calendario_data,
                cmap=cores[companhia],
                linewidths=0.5,
                linecolor='lightgray',
                cbar=False,
                ax=ax,
                vmin=0, vmax=tabela_percentual['percentual_atrasos'].max()
            )
            
            ax.set_xticklabels(['S', 'M', 'T', 'W', 'T', 'F', 'S'])
            ax.xaxis.tick_top()
            
            ax.set_title(mes, fontsize=14, pad=20)
            ax.set_xlabel('')
            ax.set_ylabel('')
            ax.tick_params(left=False, bottom=False)
            ax.set_yticklabels('')
            
            ax.grid(False)

        # Adiciona uma única barra de cor para toda a figura
        cbar_ax = fig.add_axes([0.9, 0.15, 0.02, 0.7])
        mappable = plt.cm.ScalarMappable(cmap=cores[companhia])
        mappable.set_array(tabela_percentual['percentual_atrasos'])
        mappable.set_clim(0, tabela_percentual['percentual_atrasos'].max())
        fig.colorbar(mappable, cax=cbar_ax, label='Proporção de Atrasos')

        plt.tight_layout(rect=[0, 0, 0.88, 1])
        plt.show()
```

